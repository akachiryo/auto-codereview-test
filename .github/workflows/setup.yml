name: ðŸš€ Team Setup

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
      
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests pandas openpyxl
        
    - name: Initialize and setup everything
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        REPO: ${{ github.repository }}
        WIKI_PATH: ./wiki
      run: |
        python scripts/setup.py
        
    - name: Wait for Wiki initialization
      run: |
        echo "Waiting for Wiki to be properly initialized..."
        sleep 5
        
    - name: Clone Wiki repository (after initialization)
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki
        token: ${{ secrets.TEAM_SETUP_TOKEN }}
      continue-on-error: true
      
    - name: Handle Wiki initialization if needed
      if: failure()
      run: |
        echo "Wiki repository not found, creating initial structure..."
        mkdir -p wiki
        cd wiki
        git init
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        
        # Create initial Home.md
        echo "# Welcome to the Wiki!" > Home.md
        echo "" >> Home.md
        echo "This is the initial page to create the Wiki repository." >> Home.md
        echo "This will be automatically updated by the setup process." >> Home.md
        
        git add .
        git commit -m "ðŸŒŸ Initialize Wiki repository"
        git remote add origin https://${{ secrets.TEAM_SETUP_TOKEN }}@github.com/${{ github.repository }}.wiki.git
        git push --set-upstream origin master || git push --set-upstream origin main
        
    - name: Update Wiki with generated content
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        REPO: ${{ github.repository }}
        WIKI_PATH: ./wiki
      run: |
        # Wiki pages ã‚’å†ç”Ÿæˆï¼ˆä»Šåº¦ã¯æ­£ã—ã„ãƒ‘ã‚¹ã«ï¼‰
        python -c "
        import os
        import sys
        sys.path.append('scripts')
        from setup import create_wiki_pages
        create_wiki_pages()
        "
        
    - name: Commit and push Wiki changes
      run: |
        if [ -d "wiki" ]; then
          cd wiki
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "ðŸš€ Auto-generated Wiki pages from GitHub Actions"
            git push --set-upstream origin master 2>/dev/null || git push --set-upstream origin main 2>/dev/null || git push
          else
            echo "No changes to commit to Wiki"
          fi
        else
          echo "Wiki directory not found, skipping Wiki update"
        fi