name: ðŸš€ Team Setup

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests pandas
        
    - name: Create GitHub Projects
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        python scripts/create_projects.py
        
    - name: Create GitHub Issues
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        python scripts/create_issues.py
        
    - name: Setup GitHub Discussions
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        python scripts/setup_discussions.py
        
    - name: Setup GitHub Wiki
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        python scripts/setup_wiki.py
        
    - name: Wait for Wiki setup
      run: |
        echo "Waiting for Wiki setup to complete..."
        sleep 5
        
    - name: Clone Wiki repository
      id: clone_wiki
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}.wiki
        path: wiki
        token: ${{ secrets.TEAM_SETUP_TOKEN }}
      continue-on-error: true
      
    - name: Create Wiki pages
      if: steps.clone_wiki.outcome == 'success'
      run: |
        if [ -d "wiki" ]; then
          cd wiki
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          # Remove all existing files except .git
          find . -not -path './.git*' -type f -delete
          
          # Generate new Wiki content
          cd ..
          python -c "
          import sys
          sys.path.append('scripts')
          from setup_wiki import generate_wiki_content
          generate_wiki_content('./wiki')
          "
          
          cd wiki
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "ðŸš€ Auto-generated Wiki pages from team setup"
            git push
          else
            echo "No changes to commit to Wiki"
          fi
        else
          echo "Wiki directory not found"
        fi
        
    - name: Display setup results
      run: |
        echo "âœ¨ Team setup completed successfully!"
        echo ""
        echo "ðŸ“‹ Generated resources:"
        echo "â€¢ ðŸ“Š 3 GitHub Projects created"
        echo "â€¢ ðŸŽ¯ Issues created and linked to projects"
        echo "â€¢ ðŸ’¬ Discussions configured with template"
        echo "â€¢ ðŸ“š Wiki pages generated"
        echo ""
        echo "ðŸ”— Access your resources:"
        echo "â€¢ Projects: https://github.com/${{ github.repository }}/projects"
        echo "â€¢ Issues: https://github.com/${{ github.repository }}/issues"
        echo "â€¢ Discussions: https://github.com/${{ github.repository }}/discussions"
        echo "â€¢ Wiki: https://github.com/${{ github.repository }}/wiki"